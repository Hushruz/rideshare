{% extends "layout.html" %}

{% block title %}Edit User{% endblock %}

{% block head %}
{% endblock %}

{% block main %}
<div data-notify="container"></div>
<div class="panel panel-main">
    <div class="panel-heading">Update Profile</div>
    <div class="panel-body">
        <form id='form'>
            <div class="form-group">
                <label>Name</label>
                <input type="text" class='form-control' placeholder='Name' name='{{user.name}}'>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type='email' class='form-control' placeholder='Email' name='email' value='{{user.email}}'>
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type='text' class='form-control' placeholder='Phone' name='phone' value='{{user.phone}}'>
            </div>
            <div class="form-group">
                <label>Profile Picture</label>
                <input type='file' name ='photo'>
                <div id="output"></div>
            </div>
            <button type='submit' class='btn btn-default'>Update information</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% raw %}
<script data-notify="template" type='text/x-handlebars-template'>
    <div class="alert alert-{{type}} alert-dismissable">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
        <strong>{{strong}}</strong> {{message}}
    </div>
</script>
{% endraw %}
<script type="text/javascript">
    var form = document.querySelector('#form');

    form.addEventListener('submit', function (e) {
        e.preventDefault();

        var form = e.target;
        
        var data = {};
        data.email = form.email.value;
        data.phone = form.phone.value;
        //data.photo = getBase64Image(form.photo);

        var photo = document.querySelector('[data-image="profile"]');

        if (photo) {
            data.photo = getBase64Image(photo);
        }

        var push = $.ajax({
            type: 'POST',
            url: window.location.pathname,
            dataType: 'json',
            contentType: 'application/json; charset=UTF-8',
            data: JSON.stringify(data)
        });

        push.done(function (data) {
            console.log(data)
        });

        push.fail(function (data, status) {
            console.log(status)
            notify({
                type: 'danger'
            });
        });
    });

    function getBase64Image(imgElem) {
        // imgElem must be on the same server otherwise a cross-origin error will be thrown "SECURITY_ERR: DOM Exception 18"
        var canvas = document.createElement("canvas");
        canvas.width = imgElem.clientWidth;
        canvas.height = imgElem.clientHeight;
        var ctx = canvas.getContext("2d");
        ctx.drawImage(imgElem, 0, 0);
        var dataURL = canvas.toDataURL("image/png");
        // return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
        return dataURL;
    }

    var file_input = document.querySelector('[type="file"]');

    file_input.addEventListener('change', disp_image);

    function disp_image (e) {
        var file = e.target.files[0];
        var output = document.querySelector('#output');
        var img = document.createElement('img');
        img.file = file;
        img.setAttribute('data-image', 'profile');
        output.appendChild(img);

        if (!file.type.match('image.*')) {
            console.log('Not an image.');
        }

        var reader = new FileReader();

        reader.onload = function (e) {
            img.src = e.target.result;
        }.bind(this);

        reader.readAsDataURL(file);
    }
</script>
{% endblock %}
