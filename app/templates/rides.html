{% extends "layout.html" %}

{% block title %}Rides{% endblock %}

{% block head %}
{% endblock %}

{% block main %}
<div id="alert_container"></div>
<div class="btn-group btn-group-justified">
    <div class="btn-group">
        <button type='button' class='btn btn-default'>My Rides</button>
    </div>
    <div class="btn-group">
        <button type='button' class='btn btn-default'>All Rides</button>
    </div>
</div>
<div class="row">
    
</div>
<div class="table-responsive" data-container='tables'>
    <div data-loading class='hidden'>
        <div class="spinner">
            <div class="double-bounce1"></div>
            <div class="double-bounce2"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}

{% raw %}

<script data-template='join_ride' type="text/x-handlebars-template">
    <h1>Join a ride</h1>
    <div class="entry">
        <strong>Origin:</strong> {{origin}}
    </div>
    <div class="entry">
        <strong>Destination:</strong> {{dest}}
    </div>
    <div class="entry">
        <strong>Date:</strong> {{date}}
    </div>
    <div class="entry">
        <strong>Time:</strong> {{time}}
    </div>
    <div class="entry">
        <strong>Driver:</strong> {{driver_name}}
    </div>
    <div class="entry">
        <strong>Driver contact:</strong> {{contact}}
    </div>
    <button class="btn btn-primary btn-large" data-join='passenger:{{id}}'>Join as Passenger</button>
    {{#unless driver}}
    <button class='btn btn-primary btn-large' data-join='driver:{{id}}'>Join as Driver</button>
    {{/unless}}
</script>

<script data-template='rides' type="text/x-handlebars-template">
<hr>
<h1>Existing Rides</h1>
{{#if rides}}
    <table class='table'>
        <tr>
            <th>Driver</th>
            <th>Origin</th>
            <th>Destination</th>
            <th>Spots available</th>
            <th>Date</th>
            <th>Phone #</th>
            <th>Options</th>
        </tr>
        {{#each rides}}
            <tr>
                <td>
                    {{#if driver}}
                        {{driver_name}}
                    {{else}}
                        No Driver
                    {{/if}}
                </td>
                <td>
                    {{origin_add}}
                </td>
                <td>
                    {{dest_add}}
                </td>
                <td>
                    {{passengers_max}}
                </td>
                <td>
                    {{date}}
                </td>
                <td>
                    {{contact}}
                </td>
                <td>
                    <button data-join="passenger:{{id}}" class='btn btn-primary'>Join as passenger</button>
                </td>
            </tr>
        {{/each}}
    </table>
{{else}}
    <p>There are no rides currently</p>
{{/if}}
</script>

<script id='alert_template' type='text/x-handlebars-template'>
    <div class="alert alert-{{type}} alert-dismissable">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
        <strong>{{strong}}</strong> {{message}}
    </div>
</script>

{% endraw %}

<script src="static/augment.js" type="text/javascript"></script>
<script src="static/flow.js" type="text/javascript"></script>
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>


<script type="text/javascript">
function getParameterByName(name) {

    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regexS = "[\\?&]" + name + "=([^&#]*)";
    var regex = new RegExp(regexS);
    var results = regex.exec(window.location.search);
    if(results == null)
        return "";
    else
        return decodeURIComponent(results[1].replace(/\+/g, " "));
        
}
var table_container = document.querySelector('[data-container="tables"]');
var req_rides = $.ajax({
    type: 'POST',
    url: '/rides',
    dataType: 'json',
    contentType: 'application/json; charset=UTF-8',
    data: JSON.stringify({
        circle: getParameterByName('circle')
    })
});
req_rides.done(function (data) {
    var ride_layout = document.querySelector('[data-template="rides"]')
    var template = Handlebars.compile(ride_layout.innerHTML)
    var html = template({
        rides: data
    })
    table_container.insertAdjacentHTML(
        'beforeend',
        html
    )
}.bind(this));
req_rides.fail(function (message, status) {

}.bind(this));

var flow = new Flow();
</script>

{% endblock %}