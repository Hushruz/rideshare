{% extends "layout.html" %}

{% block title %}Event{% endblock %}

{% block head %}
{% endblock %}

{% block main %}
<div class="row">
	<div class="col-md-6">
		<div class="panel panel-main">
			<div class="panel-heading">Event details</div>
			<div class="panel-body">
				<ul class="information">
					<li>
						<b>Event name:</b> {{event.name}}
					</li>
					<li>
						<b>Description:</b> {{event.details}}
					</li>
					<li>
						<b>Date:</b> {{event.date_str}}
					</li>
				</ul>
				<hr>
				<button class='btn btn-primary' data-toggle='modal' data-target='#need_ride'>I need a ride to this event</button>
				<button class='btn btn-primary' data-toggle='modal' data-target='#offer_ride'>I can offer a ride to this event</button>
			</div>
		</div>
	</div>
	<div class="col-md-6">
		<div class="panel panel-main">
			<div class="panel-heading">
				Event Location
			</div>
			<div class="panel-body">
				<div id="map_event"></div>
			</div>
		</div>
	</div>
</div>

<div class="row">
	<div class="col-md-12">
		<div class="panel panel-main">
			<div class="panel-heading">Rides going to Event</div>
			<div class="panel-body panel-no">
				{% if rides %}
					{% for ride in rides %}
						<div class='block'>
							<div class="title">
								<a href="/ride/{{ride.key().id()}}">{{ride.orig}} to {{ride.dest}}</a>
							</div>
							<div class="details">
								<div class="deta">
									<i class="fa fa-calendar"></i> {{ride.date}}
								</div>
								{% if ride.is_driver %}
									<div class="deta">
										<i class="fa fa-automobile"></i> Driver
									</div>
								{% elif ride.is_passenger %}
									<div class="deta">
										<i class="fa fa-automobile"></i> Passenger
									</div>
								{% endif %}
							</div>
						</div>
					{% endfor %}
				{% else %}
				    <div class="panel-message">
				        There are not rides going to this event. Create one by visiting <a href="/map">the map</a>.
				    </div>
				{% endif %}
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="need_ride" tabindex="-1" role="dialog" aria-aria-hidden="true">
    <div class="modal-dialog">
        <form data-send="pass">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Need a ride</h4>
                </div>
                <div class="modal-body">
                	<div class="form-group">
                		<label>Starting address</label>
                		<input class="form-control" type="text" placeholder="address" name='Address'>
                	</div>
		            <div class="form-group">
		                <label>Date</label>
		                <input class="form-control date-select" type="text" placeholder="Date" name='date'>
		            </div>
		            <div class="form-group">
		                <label>Time</label>
		                <input class="form-control" type="text" placeholder="Time" name='time'>
		            </div>
		            <div class="form-group">
		                <label>Additional Details</label>
		                <input class="form-control" type="text" placeholder="Details" name='details'>
		            </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" type='submit'>
                        Be the Driver
                    </button>
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Close</button>
                </div>
            </div><!-- /.modal-content -->
        </form>
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="offer_ride" tabindex="-1" role="dialog" aria-aria-hidden="true">
    <div class="modal-dialog">
        <form data-send="driver">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Offer a ride</h4>
                </div>
                <div class="modal-body">
                	<div class="form-group">
                		<label>Starting address</label>
                		<input class="form-control" type="text" placeholder="address" name='Address'>
                	</div>
		            <div class="form-group">
		                <label>Max Passengers</label>
		                <select class="form-control" name='max_passengers'>
		                    <option>1</option>
		                    <option>2</option>
		                    <option>3</option>
		                    <option>4</option>
		                    <option>5</option>
		                    <option>6</option>
		                    <option>7</option>
		                    <option>8</option>
		                </select>
		            </div>
		            <div class="form-group">
		                <label>Date</label>
		                <input class="form-control date-select" type="text" placeholder="Date" name='date'>
		            </div>
		            <div class="form-group">
		                <label>Time</label>
		                <input class="form-control" type="text" placeholder="Time" name='time'>
		            </div>
		            <div class="form-group">
		                <label>Additional Details</label>
		                <input class="form-control" type="text" placeholder="Details" name='details'>
		            </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" type='submit'>
                        Be the Driver
                    </button>
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Close</button>
                </div>
            </div><!-- /.modal-content -->
        </form>
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<div class='comments'>
    <div class="panel panel-main">
        <div class="panel-heading">Comments</div>
        <div class="panel-body" data-comment='container'>
            <form data-comment='form' autocomplete='off'>
                <div class="form-group">
                    <label>Comment</label>
                    <textarea class='form-control' rows='3' name='comment'></textarea>
                </div>
                <button type='submit' class='btn btn-primary'>Post Comment</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB15X6ti6tDQUQKjwPCI2zi3XFfxZW3MGM&sensor=false" type="text/javascript"></script>
<script src="/static/augment.js" type="text/javascript"></script>
<script type="text/javascript" src='/static/comment.js'></script>
<script src='//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.0/js/bootstrap.js' type="text/javascript"></script>
{% include 'comment.html' %}
{% raw %}
<script data-notify="template" type='text/x-handlebars-template'>
    <div class="alert alert-{{type}} alert-dismissable">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
        <strong>{{strong}}</strong> {{message}}
    </div>
</script>
{% endraw %}
<script type="text/javascript">
var comment = new Comment({
    type: 'event',
    id: {{event.key().id()}},
    container: '[data-comment="container"]'
});

/* Map */
var position = new google.maps.LatLng({{event.lat}}, {{event.lng}});

var icon = {
	url: '/static/person.png',
	anchor: new google.maps.Point(20, 20),
	size: new google.maps.Size(30, 40)
};

var map = new google.maps.Map(document.querySelector('#map_event'), {
    draggableCursor: 'crosshair',
    center: position,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    zoom: 10
});

var event_marker = new google.maps.Marker({
	position: position,
	map: map,
	icon: icon
});

var info_window = new google.maps.InfoWindow({
	content: 'Event Location'
});

google.maps.event.addListener(event_marker, 'click', function () {
	info_window.open(map, event_marker);
});
/* End */

    var form_driver = document.querySelector('[data-send="driver"]');

    form.addEventListener('submit', function (e) {
        e.preventDefault();

        var form = e.target;

        var data = {};
        data.max_passengers = form.max_passengers.value;
        data.time = form.time.value;
        data.details = form.details.value;

        var push = $.ajax({
            type: 'POST',
            url: '/event/{{event.key().id()}}/driver',
            dataType: 'json',
            contentType: 'application/json; charset=UTF-8',
            data: JSON.stringify(data)
        });

        push.done(function (data) {
            document.location = '/ride/' + data.id;
        });

        push.fail(function (data, status) {
            notify({
                type: 'danger',
                strong: 'Oops',
                message: 'Refresh and try again'
            });
        });
    });

    var form_pass = document.querySelector('[data-send="pass"]');

    form.addEventListener('submit', function (e) {
        e.preventDefault();

        var form = e.target;

        var data = {};
        data.max_passengers = form.max_passengers.value;
        data.time = form.time.value;
        data.details = form.details.value;

        var push = $.ajax({
            type: 'POST',
            url: '/event/{{event.key().id()}}/pass',
            dataType: 'json',
            contentType: 'application/json; charset=UTF-8',
            data: JSON.stringify(data)
        });

        push.done(function (data) {
            document.location = '/ride/' + data.id;
        });

        push.fail(function (data, status) {
            notify({
                type: 'danger',
                strong: 'Oops',
                message: 'Refresh and try again'
            });
        });
    });

</script>
{% endblock %}