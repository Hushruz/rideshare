{% extends "layout.html" %}

{% block title %}Circles{% endblock %}

{% block head %}

{% endblock %}

{% block main %}
<div class="btn-group btn-group-justified">
    <div class="btn-group">
        <button type='button' class='btn btn-default' data-next="my_circles">My Circles</button>
    </div>
    <div class="btn-group">
        <button type='button' class='btn btn-default' data-next="all_circles">All Circles</button>
    </div>
    <div class="btn-group">
        <a href="/newCircle" class='btn btn-default'>
            <i class='fa fa-plus-circle'></i>
            Create a Circle
        </a>
    </div>
</div>

<div data-route='my_circles'>
{% for circle in circles_user %}
    <h2>
        <a href="/map?circle={{circle.key.id}}">{{ circle.name }}</a>
    </h2>

    {% for item in event_list %}

        {% if item.circle == circle.key.id %}
            <table >
                <tr>
                    <th>Event Name</th>
                    <th>Event Address</th>
                    <th>Event Date</th>
                    <th>Event Time</th>
                </tr>
                <tr>
                    <td>{{ item.name }}</td>
                    <td>{{ item.address }}</td>
                    <td>{{ item.ToD }}</td>
                    <td>{{ item.time }}</td>
                </tr>
            </table>
            </br>
        {% endif %}

    {% endfor %}
    <a href='/map?circle={{circle.key().id()}}' class='btn btn-success btn-large'>
        Add events for this circle
        <i class='fa fa-plus'></i>
    </a>
    <hr>
{% endfor %}
</div>

<div data-route='all_circles'>
    <div class="circles">
    {% for circle in circles_all %}
        <div class="circle">
            <h2>{{ circle.name }}</h2>
            <p>{{ circle.description }}</p>
            <div class='switch' data-id='{{ circle.key().id() }}'
                {% if circle.key() in user.circles %}
                    data-switch='true'
                {% else %}
                    data-switch='false'
                {% endif %}
            >
                <div class="true_padding"></div>
                <div class="true">In</div>
                <div class="false_padding"></div>
                <div class="false">Out</div>
            </div>
        </div>
    {% endfor %}
    </div>
</div>


{% endblock %}

{% block scripts %}

{% raw %}

<script data-notify="template" type='text/x-handlebars-template'>
    <div class="alert alert-{{type}} alert-dismissable">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
        <strong>{{strong}}</strong> {{message}}
    </div>
</script>

{% endraw %}

<script src="static/augment.js" type="text/javascript"></script>
<script src="static/flow.js" type="text/javascript"></script>
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>

<script type="text/javascript">
    var flow = new Flow('my_circles');

    var switcher = function (e) {
        var target = e.target;
        if (!target.hasAttribute('data-switch')) {
            target = target.parentNode;
        }
        if (target.dataset.switch == 'true') {
            target.dataset.switch = 'false';
        } else {
            target.dataset.switch = 'true';
        }

        var data = {}
        data.user = {{ user.key().id() }}
        if (target.dataset.switch == 'true') {
            data.action = 'add';
        } else {
            data.action = 'remove';
        }
        data.circle = target.dataset.id;
        
        var req = $.ajax({
            type: 'POST',
            url: '/join_circle',
            dataType: 'json',
            contentType: 'application/json; charset=UTF-8',
            data: JSON.stringify(data)
        });
    }

    var switchs = document.querySelectorAll('.switch');

    for (var i = 0; i < switchs.length; i++) {
        var current = switchs[i];
        current.addEventListener('click', switcher);
    }
</script>

{% endblock %}