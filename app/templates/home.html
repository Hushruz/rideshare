{% extends "layout.html" %}

{% block title %}Home{% endblock %}

{% block head %}

{% endblock %}

{% block main %}
<div data-notify='container'></div>
<div class="row">
    <div class="col-md-6">
        <div class="panel panel-main">
            <div class="panel-heading">Alerts</div>
            <div class="panel-body panel-no">
                {% if notis %}
                    {% for noti in notis %}
                        <div class="list" data-parent='{{noti.key().id()}}'>
                            <div class="ctx">
                                <i class="fa fa-paper-plane"></i>
                            </div>
                            <div class="info">
                                <div class="title">
                                    {{noti.text | safe}}
                                </div>
                                <div class="sub">
                                    <a href="/ride/{{noti.ride.key().id()}}" class='btn btn-primary btn-xs'>
                                        <i class="fa fa-automobile"></i>
                                        {{noti.ride.orig}} to {{noti.ride.dest}}
                                    </a>
                                    <button class='btn btn-danger btn-xs' data-alert='{{noti.key().id()}}'>
                                        <i class="fa fa-times"></i>
                                        Dismiss
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                <div class="panel-message">
                    You do not have any alerts.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="panel panel-main">
            <div class="panel-heading">Notifications - Upcoming Events</div>
            <div class="panel-body panel-no">
                {% if upcoming %}
                    {% for up in upcoming %}
                        <div class="list">
                            <div class="ctx">
                                <i class="fa fa-exclamation"></i>
                            </div>
                            <div class="info">
                                <div class="title">
                                    <a href="/ride/{{up.key().id()}}">Ride to {{up.dest_add}}</a>
                                </div>
                                <div class="sub">
                                    <i class="fa fa-calendar"></i> {{up.date_str}}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="panel-message">
                        You do not have any upcoming events.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="panel panel-main">
    <div class="panel-heading">Quick options</div>
    <div class="panel-body panel-no">
        <div class="block">
            <div class="title">
                <a href="/map">Create Rides and Events</a>  
            </div>
        </div>
        <div class="block">
            <div class="title">
                <a href="/circles">Join a Circle</a>  
            </div>
        </div>
        <div class="block">
            <div class="title">
                <a href="/user">Edit Profile</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}

{% raw %}

<script data-notify="template" type='text/x-handlebars-template'>
    <div class="alert alert-{{type}} alert-dismissable">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
        <strong>{{strong}}</strong> {{{message}}}
    </div>
</script>

{% endraw %}

<script src="static/augment.js" type="text/javascript"></script>

<script type="text/javascript">
    var send_req = function (id) {
        var push = $.ajax({
            type: 'POST',
            url: '/alert/' + id + '/dismiss',
            dataType: 'json',
            contentType: 'application/json; charset=UTF-8',
            data: JSON.stringify({
                id: id
            })
        });

        push.done(function (data) {
            var parent = document.querySelector('[data-parent="' + id + '"]');
            parent.parentNode.removeChild(parent);
        });

        push.fail(function (data, status) {
            notify({
                type: 'danger',
                strong: 'Whoops',
                message: 'Alert does not exist.'
            });
        });
    };

    document.body.addEventListener('click', function (e) {
        var target = e.target;

        if (target.dataset.alert) {
            send_req(target.dataset.alert);
        }
    });
</script>

{% endblock %}