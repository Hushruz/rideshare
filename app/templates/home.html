{% extends "layout.html" %}

{% block title %}Home{% endblock %}

{% block head %}

{% endblock %}

{% block main %}
<div data-notify='container'></div>
<div class="row hidden" data-help='container'>
    <div class="col-md-4">
        <ul class='list-group'>
            <a href="#q1" data-toggle='tab' class='list-group-item active'>
                What is an alert?
            </a>
            <a href="#q2" data-toggle='tab' class='list-group-item'>
                What is a notification?
            </a>
            <a href="#q3" data-toggle='tab' class='list-group-item'>
                Can I be emailed when I recieve an alert?
            </a>
        </ul>
    </div>
    <div class="col-md-8">
        <div class="tab-content">
            <div class="tab-pane active" id="q1">
                Alerts are important messages regarding rides you are connected to. You will be alerted if:

                If you are a passenger and the driver of the ride leaves.
                If you are a passenger and the ride gets a driver.
                If you are a driver and a passenger joins your ride.
                If you are a driver and a passenger leaves your ride.

                These alerts will always be shown on your home page but you can also receive these messages through email. Set your preferences by visiting your profile page.
            </div>
            <div class="tab-pane" id="q2">
                Notifications are reminders about upcoming rides. Notifications are shown on your home page.
            </div>
            <div class="tab-pane" id="q3">
                Yes! Visit your notification preference page.
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-6">
        <div class="panel panel-main">
            <div class="panel-heading">
                Notifications
                <div class="pull-right">
                    <i class="fa fa-question" data-help='toggle'></i>
                </div>
            </div>
            <div class="panel-body panel-no">
                {% if notis %}
                    {% for noti in notis %}
                        <div class="list" data-parent='{{noti.key().id()}}'>
                            <div class="ctx">
                                <i class="fa fa-paper-plane"></i>
                            </div>
                            <div class="info">
                                <div class="title">
                                    {{noti.text | safe}}
                                </div>
                                <div class="sub">
                                    <a href="/ride/{{noti.ride.key().id()}}" class='btn btn-primary btn-xs'>
                                        <i class="fa fa-automobile"></i>
                                        {{noti.ride.orig}} to {{noti.ride.dest}}
                                    </a>
                                    <button class='btn btn-danger btn-xs' data-alert='{{noti.key().id()}}'>
                                        <i class="fa fa-times"></i>
                                        Dismiss
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                <div class="panel-message">
                    You do not have any notifications.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="panel panel-main">
            <div class="panel-heading">
                Reminders - Upcoming Events
                <div class="pull-right">
                    <i class="fa fa-question" data-help='toggle'></i>
                </div>
            </div>
            <div class="panel-body panel-no">
                {% if upcoming %}
                    {% for up in upcoming %}
                        <div class="list">
                            <div class="ctx">
                                <i class="fa fa-exclamation"></i>
                            </div>
                            <div class="info">
                                <div class="title">
                                    <a href="/ride/{{up.key().id()}}">Ride to {{up.dest_add}}</a>
                                </div>
                                <div class="sub">
                                    <i class="fa fa-calendar"></i> {{up.date_str}}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="panel-message">
                        You do not have any upcoming events.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="panel panel-main">
            <div class="panel-heading">Quick options</div>
            <div class="panel-body panel-no">
                <div class="list">
                    <div class="ctx">
                        <i class="fa fa-map-marker"></i>
                    </div>
                    <div class="info">
                        <div class="title">
                            <a href="/map">Create Rides and Events</a>
                        </div>
                    </div>
                </div>
                <div class="list">
                    <div class="ctx">
                        <i class="fa fa-circle-o"></i>
                    </div>
                    <div class="info">
                        <div class="title">
                            <a href="/circles">Join a Circle</a>
                        </div>
                    </div>
                </div>
                <div class="list">
                    <div class="ctx">
                        <i class="fa fa-car"></i>
                    </div>
                    <div class="info">
                        <div class="title">
                            <a href="/rides">Join a Ride</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="panel panel-main">
            <div class="panel-heading">My Circles</div>
            <div class="panel-body panel-no">
            {% if circles %}
                {% for circle in circles %}
                    {% if circle.user %}
                    <div class="list" data-circle='{{circle.key().id()}}'>
                    {% else %}
                    <div class="list hidden" data-circle='{{circle.key().id()}}'>
                    {% endif %}    
                        {% if circle.color %}
                        <div class="ctx" style='background-color:{{circle.color}};'>
                        {% else %}
                        <div class="ctx">
                        {% endif %}
                            <i class='fa fa-circle-o'></i>
                        </div>
                        <div class="info">
                            <div class="title">
                                <a href='/circle/{{circle.key().id()}}'>{{circle.name}}</a>
                            </div>
                            <div class="sub">
                                <a href='/circle/{{circle.key().id()}}/change'>
                                    Add events for this circle
                                </a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="panel-message">
                    You have not joined any circles.
                </div>
            {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}

{% raw %}

<script data-notify="template" type='text/x-handlebars-template'>
    <div class="alert alert-{{type}} alert-dismissable">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
        <strong>{{strong}}</strong> {{{message}}}
    </div>
</script>

{% endraw %}

<script src="static/augment.js" type="text/javascript"></script>

<script type="text/javascript">
    var send_req = function (id) {
        var push = $.ajax({
            type: 'POST',
            url: '/alert/' + id + '/dismiss',
            dataType: 'json',
            contentType: 'application/json; charset=UTF-8',
            data: JSON.stringify({
                id: id
            })
        });

        push.done(function (data) {
            var parent = document.querySelector('[data-parent="' + id + '"]');
            parent.parentNode.removeChild(parent);
        });

        push.fail(function (data, status) {
            notify({
                type: 'danger',
                strong: 'Whoops',
                message: 'Alert does not exist.'
            });
        });
    };

    document.body.addEventListener('click', function (e) {
        var target = e.target;

        if (target.dataset.alert) {
            send_req(target.dataset.alert);
        }
    });

/* Toggle Help */
var help = {};
help.btn = document.querySelector('[data-help="toggle"]');
help.container = document.querySelector('[data-help="container"]');

help.btn.addEventListener('click', function (e) {
    var target = e.target;

    help.container.classList.toggle('hidden');
});
/* End */
</script>

{% endblock %}